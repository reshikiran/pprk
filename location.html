<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Location from Excel</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
    #map {
        height: 400px;
    }
</style>
</head>
<body>
<h2>Upload Excel File</h2>
<input type="file" id="fileInput" accept=".xls,.xlsx">
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
document.getElementById('fileInput').addEventListener('change', handleFileSelect, false);

function handleFileSelect(event) {
    const file = event.target.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        // Fetch coordinates for each location asynchronously
        const promises = sheetData.map(row => fetchCoordinates(row[1]));
        Promise.all(promises)
        .then(coordinates => {
            // Generate table once all coordinates are fetched
            generateMap(sheetData, coordinates);
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('map').innerHTML = 'Error retrieving location. Please try again.';
        });
    };

    reader.readAsArrayBuffer(file);
}

function fetchCoordinates(location) {
    const url = 'https://api.mapbox.com/geocoding/v5/mapbox.places/' + location + '.json?access_token=pk.eyJ1IjoicmVzaGlraXJhbm5jIiwiYSI6ImNsdW1ocXBjMzE5YTcybGxtYTQxZHV0ZGgifQ.OylEs7tlZBA-pzw2z0_TYA';
    return fetch(url)
    .then(response => response.json())
    .then(data => {
        const coordinates = data.features[0].center;
        return coordinates;
    });
}

function generateMap(data, coordinates) {
    const map = L.map('map').setView([20.5937, 78.9629], 5); // Centered on India

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    data.forEach((row, index) => {
        const name = row[0];
        const location = row[1];
        const latitude = coordinates[index][1];
        const longitude = coordinates[index][0];

        L.marker([latitude, longitude]).addTo(map)
        .bindPopup(`<b>${name}</b><br>${location}`)
        .openPopup();
    });
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
</body>
</html>
